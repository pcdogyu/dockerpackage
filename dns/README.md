# DNS Container

This container serves DNS requests via `bind`. It needs to be in the same network namespace as the __Oasis__ container, since some __GMPTIC__ operations
rely on Oasis calls.

A container with bind and one with oasis get started in the same network namespace, to receive GMP/TIC updates (rndc, nsupdate), that are sent via oasis. A docker bind-mount is attached to both containers. This is required for new zone files, that are added with rndc, as well as DNS forwarder configuration (managed by terraform).

The ports (oasis and dns) are exposed in the dns container only and the oasis container is just using the same network namespace.

The container will be started together with __Oasis__ and __Chef__ by compose file `svc-dns-oasis-chef.yaml`.


## Information for hidden master setup

The DNS container is capable of two modes. The first one is the standalone mode which provides a master instance to you.
The second mode is for a master-slave setup which can be rolled out on a docker swarm cluster.
This mode requires a master service with one instance and a slave service with several instances.

The slave containers have a dependency to the master container and there has to be a shared volume which is used for sharing common keys
for all slave instances. The key will be generated by the master during the first startup.
On the master instance a python proxy script is running to intercept all DNS-notify requests from named and forward the request to all docker swarm tasks of the slave service ( dns round-robin: "tasks.dns-slave").
There is also a sync loop on the master which periodically checks all slaves for their current status and updates them. This is helpful when the slave service is scaled up and new instances get spawned.
On the slave nodes a python job is periodically checking if there is a need to delete old zones on the slave.

Depending on the environment variables the entrypoint script will setup a standalone master, a master in a hidden-master setup or a slave instances.

Example for standalone container:

```
version: "3.5"
services:
  dns-master:
    image: dns-latest
    environment:
      - DNS_FORWARDER=8.8.8.8
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "953:953/tcp"
    volumes:
      - /opt/compose/custom_configs/dns-data:/data
      - /opt/compose/custom_configs/dns:/dns-config
    deploy:
        replicas: 1
```

Example for hidden master setup:

```
version: "3.5"
services:
  dns-master:
    image: dns-latest
    environment:
      - DNS_FORWARDER=8.8.8.8
      - hidden_master=true
      - bind_mode=master
      - myMasterService=dns-master
      - mySlaveService=dns-slave
      - myMasterKey=/var/lib/named/etc/bind/rndc.key
      - mySlaveKey=/keys/rndc-slave.key
      - nzfFile=/var/lib/named/_default.nzf
      - multicastIP=147.204.152.38
    ports:
      - "1153:53/tcp"
      - "1153:53/udp"
      - "953:953/tcp"
    volumes:
      - /opt/compose/custom_configs/dns-data:/data
      - /opt/compose/custom_configs/dns:/dns-config
      - /opt/compose/custom_configs/dns-keys:/keys
    deploy:
        replicas: 1

  dns-slave:
    image: alex-dns
    environment:
      - DNS_FORWARDER=8.8.8.8
      - hidden_master=true
      - bind_mode=slave
      - myMasterService=dns-master
      - mySlaveService=dns-slave
      - myMasterKey=/var/lib/named/etc/bind/rndc.key
      - mySlaveKey=/keys/rndc-slave.key
      - nzfFile=/var/lib/named/_default.nzf
      - multicastIP=147.204.152.38
    ports:
      - "53:53/tcp"
      - "53:53/udp"
    volumes:
      - /opt/compose/custom_configs/dns-keys:/keys
    depends_on:
      - "dns-master"
    deploy:
        replicas: 3
```


## Usage

The following volumes are intended to be used:

| Volume | Type | Used for|
| ------------- |
| /data | bind mount | config dir for named and forwarders, included by `named.conf` |

The following variables are required.

| Variables |
| ------------- |
| ORG |
| DNS_FORWARDER |

Pull the latest images for dns and oasis container:

```
docker pull gcr.io/${gcr}/dns:latest
#or: docker pull docker.wdf.sap.corp:65349/dns:latest

docker pull gcr.io/${gcr}/oasis:latest
#or: docker pull docker.wdf.sap.corp:65349/oasis:latest

docker tag gcr.io/${gcr}/dns:latest dns:latest
docker tag gcr.io/${gcr}/dns:latest oasis:latest
```

Docker compose will startup both containers and expose the right ports:

```
docker network create --driver bridge --scope local my_network
docker-compose -f ./services/svc-dns-oasis-chef.yaml up -d
```

To spawn the containers manually:

```
docker run -d -v dns:/data -p 53:53 -p 8086:8086 --name dns gcr.io/${gcr}/dns:latest
docker run -d -v dns:/data --name oasis --network=container:dns gcr.io/${gcr}/oasis:latest
```
